pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

-- globals
tile_size = 8 -- tile size
min_tile = 0
max_tile = 15
world_size = 128 -- pixels
left,right,up,down,use1,use2=0,1,2,3,4,5
black,dark_blue,dark_purple,dark_green,brown,dark_gray,light_gray,white,red,orange,yellow,green,blue,indigo,pink,peach=0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
ent_types = {"s", "c", "a", "f", "u"} -- snail, clean, algae, fish, unknown
move_cooldown = 0.5

-- Random tiles start growing algae
-- world updates realtime
-- need to figure out a movement cap

-- start engine code
function min(l, r)
	if l < r then
		return l
	else
		return r
	end
end
function max(l, r)
	if l > r then
		return l
	else
		return r
	end
end
-- quick and dirty lerp, not mathematically perfect, but it gets the job done
function lerp (from, to, step)
	if abs(from - to ) < step then
		return to
	end

	if from > to then
		return max(to, from-step)
	elseif from < to then
		return min(to, from+step)
	else
		return to
	end
end

world = {}
function world:new()
	this = {}
	setmetatable(this, self)
	self.__index=self

	this.ents = {}

	return this
end
function world:add_entity(ent)
	ent:init()
	add(self.ents, ent)
end
function world:draw()
	cls(blue)
	map(0, 0, 0, 0, 16, 16)
	for entity in all(self.ents) do
		entity:draw()
	end
end
function world:update()
	for entity in all(self.ents) do
		entity:update()
	end
end

ent = {}
function ent:new(spr, x, y)
	this = {}
	setmetatable(this, self)
	self.__index=self

	this.type = "u"

	-- position (tile coordinates)
	this.x = x
	this.y = y

	-- sprites
	this.s = spr   -- active
	this.t = 0     -- timer
	this.f = false -- flip?

	-- animation
	this.a = nil -- active
	this.l = {}  -- list of anims

	-- movement timer
	this.m = 0

	return this
end
function ent:init()
	-- initialization
end
function ent:draw()
	spr(self.s, self.x * tile_size, self.y * tile_size, 1, 1, self.f)
end
function ent:update()
	self.t = time()
	self:handle_anim()
end
function ent:add_anim(name, anim)
	self.l[name] = anim
end
function ent:handle_anim()
	if self.a then
		local anim = self.l[self.s]
		if time() - anim.t > anim.d then
			self.s += 1
			if self.s > anim.e or self.s < anim.s then
				self.s = anim.s
			end
			anim.t = time()
		end
	end
end

anim = {}
function anim:new(s, e, d)
	this = {}
	setmetatable(this, self)
	self.__index=self

	this.s = s -- start frame
	this.e = e -- end frame
	this.t = 0 -- timer
	this.d = d

	return this
end
-- end engine code


-- helper function to create the player (snail)
function player(sx, sy)
	local p = ent:new(0, sx, sy)
	p.type = "s"

	-- movement for lerping
	p.mx = p.x
	p.my = p.y

	p.draw = function()
		ent.draw(p) -- super
	end

	p.update = function()
		ent.update(p) -- super
		if (p.t - p.m) > move_cooldown then
			if btn(left) and p.x > min_tile then
				p.mx -= 1
				p.s = 1
				p.f = true
			elseif btn(right) and p.x < max_tile then
				p.mx += 1
				p.s = 1
				p.f = false
			else
				p.mx = p.x
			end
			if btn(up) and p.y > min_tile then
				p.my -= 1
				p.s = 0
			elseif btn(down) and p.y < max_tile then
				p.my += 1
				p.s = 0
			else
				p.my = p.y
			end

			if p.x ~= p.mx or p.y ~= p.my then -- moving
				p.m = time()
			else
				p.s = 0
			end
		end
		p.x = lerp(p.x, p.mx, 0.1)
		p.y = lerp(p.y, p.my, 0.1)
	end
	return p
end

function algae(x, y)
	local a = ent:new(16, x, y) -- 16 - 19

	a.gt = 0 -- grow timer

	a.draw = function()
		ent.draw(a)
	end

	a.update = function()
		ent.update(a)
		a.gt += dt
	end

	return a
end

world_1 = world:new()
world_1:add_entity(player(8, 8))

-- TODO: Randomly place algae after certain times
world_1:add_entity(algae(12, 12))

active_world = world_1

last_frame = 0.0
dt = 0.0
function _draw()
	active_world:draw()
end

function _update()
	dt = time() - last_frame
	last_frame = time()
	active_world:update()
end

__gfx__
04444000044440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49999400499994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49499b0b494994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4494b1314494b1300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4494b333449493330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
499494b34994b1330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
494994b3494994b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04444b3304444b330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000030000000303003003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000303003003030030033300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00003000000030000300303033003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00030000000300003033000030333303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000030000000300003003300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000003000003033000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000030300000303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000099990099990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99900999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020002020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021202120212021202120202021202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000002222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
